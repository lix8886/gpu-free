<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPUFree</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>GPUç›‘æ§ä¸è®¢é˜…é¢æ¿ã€218ã€‘</h1>
            <div id="connection-status" class="status-disconnected">â— æœªè¿æ¥</div>
        </header>

        <main>
            <section id="live-status-container" class="live-status-grid">
                {% if not gpus %}
                <div class="card error-card">
                    <h2><span class="icon">âŒ</span> é”™è¯¯</h2>
                    <p>æœªæ£€æµ‹åˆ° NVIDIA GPU æˆ–æ— æ³•åˆå§‹åŒ– NVML åº“ã€‚</p>
                </div>
                {% else %}
                {% for gpu in gpus %}
                <div class="card live-gpu-card" id="gpu-{{ gpu.id }}">
                    <h3><span class="icon">ğŸ’»</span> {{ gpu.name }}</h3>
                    <div class="live-stat-value">--%</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </section>

            <section class="card">
                <h2><span class="icon">ğŸ“Š</span> å ç”¨ç‡å†å² (è¿‡å»10min)</h2>
                <div class="chart-container">
                    <canvas id="history-chart"></canvas>
                </div>
            </section>

            <div class="layout-grid">
                <section class="card" id="task-manager">
                    <h2><span class="icon">ğŸ“«</span> æ·»åŠ GPUç©ºé—²è®¢é˜…</h2>
                    <p>å½“æ‰€é€‰GPUå ç”¨ç‡å…¨éƒ¨ä½äºé˜ˆå€¼æ—¶ï¼Œæ‚¨å°†æ”¶åˆ°é‚®ä»¶é€šçŸ¥ã€‚</p>
                    <form id="task-form">
                        <div class="form-group">
                            <label>é€‰æ‹©è¦ç›‘æ§çš„GPU (å¯å¤šé€‰):</label>
                            <div class="gpu-checkbox-group">
                                {% for gpu in gpus %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="gpu_ids" value="{{ gpu.id }}"> {{ gpu.name }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="util-threshold">å ç”¨ç‡ä½äºæ­¤å€¼åˆ™é€šçŸ¥ (%):</label>
                            <input type="number" id="util-threshold" min="1" max="100" value="60" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="alias">ç”¨æˆ·å:</label>
                                <input type="text" id="alias" placeholder="ä¾‹å¦‚, huihe" required>
                            </div>
                            <div class="form-group">
                                <label for="email">é€šçŸ¥é‚®ç®±åœ°å€:</label>
                                <input type="email" id="email" placeholder="user@example.com" required>
                            </div>
                        </div>
                        <button type="submit">åˆ›å»ºè®¢é˜…ä»»åŠ¡</button>
                    </form>
                    <div id="task-feedback" class="feedback"></div>
                </section>

                <section class="card">
                    <h2><span class="icon">ğŸ“‹</span> å½“å‰è®¢é˜…ä»»åŠ¡</h2>
                    <div id="task-list-container">
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusDiv = document.getElementById('connection-status');
            const taskForm = document.getElementById('task-form');
            const taskFeedback = document.getElementById('task-feedback');
            const taskListContainer = document.getElementById('task-list-container');
            const historyChartCanvas = document.getElementById('history-chart').getContext('2d');
            let historyChart;

            const GPU_COLORS = ['#7aa2f7', '#f7768e', '#e0af68', '#9ece6a', '#bb9af7', '#ff9e64', '#7dcfff', '#c0caf5'];

            // --- 1. åˆå§‹åŒ–å†å²å›¾è¡¨ ---
            function initHistoryChart() {
                historyChart = new Chart(historyChartCanvas, {
                    type: 'line',
                    data: { datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, ticks: { color: '#c0caf5' } },
                            y: { min: 0, max: 100, ticks: { color: '#c0caf5', callback: (value) => value + '%' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#c0caf5' } },
                            // ***è‡ªå®šä¹‰æ‚¬åœæ—¶çš„å·¥å…·æç¤ºä¿¡æ¯***
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value}%`;
                                    }
                                }
                            }
                        }
                    }
                });
                updateHistoryChart();
                setInterval(updateHistoryChart, 5000);
            }

            // --- 2. æ›´æ–°å†å²å›¾è¡¨æ•°æ® ---
            async function updateHistoryChart() {
                try {
                    const response = await fetch('/history');
                    const historyData = await response.json();

                    const datasets = [];
                    for (const gpuId in historyData) {
                        const gpuData = historyData[gpuId];
                        // ä»å®æ—¶å¡ç‰‡è·å–å®Œæ•´çš„GPUåç§°
                        const gpuCard = document.getElementById(`gpu-${gpuId}`);
                        const gpuName = gpuCard ? gpuCard.querySelector('h3').textContent.trim() : `GPU ${gpuId}`;

                        datasets.push({
                            label: gpuName, // å°†å®Œæ•´GPUåä½œä¸ºlabel
                            data: gpuData.map(d => ({ x: new Date(`1970-01-01T${d.time}Z`), y: d.util })),
                            borderColor: GPU_COLORS[gpuId % GPU_COLORS.length],
                            tension: 0.2,
                            pointRadius: 0,
                            pointHoverRadius: 5 // æ‚¬åœæ—¶æ˜¾ç¤ºç‚¹
                        });
                    }
                    historyChart.data.datasets = datasets;
                    historyChart.update('none');
                } catch (error) {
                    console.error("æ›´æ–°å†å²å›¾è¡¨å¤±è´¥:", error);
                }
            }

            // --- 3. æ›´æ–°ä»»åŠ¡åˆ—è¡¨ ---
            async function updateTaskList() {
                try {
                    const response = await fetch('/tasks');
                    const tasks = await response.json();
                    taskListContainer.innerHTML = '';
                    if (tasks.length === 0) {
                        taskListContainer.innerHTML = '<p class="no-tasks">æš‚æ— è®¢é˜…ä»»åŠ¡</p>';
                        return;
                    }
                    tasks.forEach(task => {
                        const taskCard = document.createElement('div');
                        taskCard.className = 'task-card';
                        // ***æ˜¾ç¤ºåˆ«ç§° (alias), å¹¶å°†é‚®ç®±åœ°å€æ”¾åœ¨titleå±æ€§ä¸­æ‚¬åœæ˜¾ç¤º***
                        taskCard.innerHTML = `
                        <div class="task-card-header">
                            <span class="task-alias" title="é‚®ç®±: ${task.email}">${task.alias}</span>
                            <button class="delete-task-btn" data-task-id="${task.id}">Ã—</button>
                        </div>
                        <div class="task-card-body">
                            å½“ <strong>${task.gpu_names.join(', ')}</strong> çš„å ç”¨ç‡å‡ä½äº <strong>${task.util_threshold}%</strong> æ—¶é€šçŸ¥ã€‚
                        </div>
                    `;
                        taskListContainer.appendChild(taskCard);
                    });
                } catch (error) {
                    console.error("è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:", error);
                }
            }

            // --- 4. WebSocket è¿æ¥ ---
            function connectWebSocket() {
                const ws = new WebSocket(`ws://${window.location.host}/ws`);
                ws.onopen = () => { statusDiv.textContent = 'â— å·²è¿æ¥'; statusDiv.className = 'status-connected'; };
                ws.onmessage = (event) => {
                    const liveStats = JSON.parse(event.data);
                    liveStats.forEach(gpu => {
                        const card = document.getElementById(`gpu-${gpu.id}`);
                        if (card) {
                            card.querySelector('.live-stat-value').textContent = `${gpu.gpu_utilization}%`;
                            card.querySelector('.progress-bar').style.width = `${gpu.gpu_utilization}%`;
                        }
                    });
                };
                ws.onclose = () => {
                    statusDiv.textContent = 'â— å·²æ–­å¼€'; statusDiv.className = 'status-disconnected';
                    setTimeout(connectWebSocket, 3000);
                };
            }

            // --- 5. äº‹ä»¶ç›‘å¬ ---
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedGpuIds = Array.from(document.querySelectorAll('input[name="gpu_ids"]:checked')).map(cb => parseInt(cb.value));
                if (selectedGpuIds.length === 0) {
                    alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªGPUï¼"); return;
                }

                const formData = {
                    gpu_ids: selectedGpuIds,
                    util_threshold: parseInt(document.getElementById('util-threshold').value),
                    email: document.getElementById('email').value,
                    alias: document.getElementById('alias').value,
                };

                const response = await fetch('/task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    taskFeedback.textContent = 'è®¢é˜…ä»»åŠ¡åˆ›å»ºæˆåŠŸ!';
                    taskFeedback.className = 'feedback success';
                    taskForm.reset();
                    updateTaskList();
                } else {
                    taskFeedback.textContent = 'åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚';
                    taskFeedback.className = 'feedback error';
                }
                setTimeout(() => taskFeedback.textContent = '', 5000);
            });

            taskListContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-task-btn')) {
                    const taskId = e.target.dataset.taskId;
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…ä»»åŠ¡å—?')) {
                        const response = await fetch(`/task/${taskId}`, { method: 'DELETE' });
                        if (response.ok) {
                            updateTaskList();
                        } else {
                            alert('åˆ é™¤å¤±è´¥!');
                        }
                    }
                }
            });

            // --- åˆå§‹åŒ– ---
            if ({{ gpus | length }} > 0) {
                connectWebSocket();
                initHistoryChart();
                updateTaskList();
                // ***æ¯2ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ä»»åŠ¡åˆ—è¡¨***
                setInterval(updateTaskList, 2000);
            }
        });
    </script>
</body>

</html>
